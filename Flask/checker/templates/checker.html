{% extends "main.html" %}
{% block title %}SnapSentinel{% endblock %}
{% block head %}
{{ super() }}

{% endblock %}
{% block content %}
<script>
    var donotupdate = false;
    var test_results;
    var test_results_divs = {};
    const extra_data_locations = [
        {%for item in extra_data%}['{{item[0]}}', '{{item[1]}}', '{{item[2]}}', '{{item[3]}}'],
        {% endfor %}
    ];
    var iframes = {};
    var opened_categories = new Set();
    var logs_for_categories = {};
    var stored_pings_results = {};
    var button_data = [
        {%for element in extra%}
        {'data':`<div class="row align-items-start"><div class="col"><input type="button" name="{{element[1]}}" id="{{element[1]}}" value="{{element[1]}}" class="form-control" onclick="runComplexTests(this)" style="background: {{element[4]}}; color: {{element[6]}}"/>
                <div>{{element[5]|safe}}</div></div>
                {%if element[3] != None%}{% for element_2 in element[3].split(';') %}{% set parts = element_2.split(':') %}
                    <input type="{{ parts[0] }}" id="{{ parts[2] }}-{{element[1]}}" name="{{ parts[2] }}" placeholder="{{parts[1]}}" class="form-control"></div>{% endfor %}{%endif%}
                <div class="col" id="{{element[1]}}-result">No data yet...</div></div>`, 'type':`{{element[7]|safe}}`},
        {%endfor%}
    ];

    const lookupTable = {
        {%for item in categories%}'{{item[0]}}': '{{item[1]}}',
        {% endfor %}'nothing': 'nothing'
    };

    function toggleUpdate() {
        if (donotupdate) {
            document.getElementById("buttonForUpdates").innerHTML = "Stop containers refresh";
            donotupdate = false;
        }
        else {
            document.getElementById("buttonForUpdates").innerHTML = "Resume containers refresh";
            donotupdate = true;
        }
    }

    function smartSleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    $( function() {
        $( "#draggable" ).draggable({ cancel: "p.ui-widget-header" });
    } );
    
    $(document).ready(async function askcontainers() {
        while (1) {
            if (!donotupdate) {
                update_routine();
                }
            await smartSleep(120000);
        }
    });


    function update_routine() {
        getcontainers();
        testsResults();
        showTestResults();
        document.getElementById("last-update").innerHTML = "Last update: " + new Date().toLocaleString();
        cg = colorGenerator();
        var buttons = document.querySelectorAll('input[type="button"]');
        buttons.forEach(button => {
            let parent = button.parentElement;
            for (let i = 1; i < 5 && parent; i++) {
              parent = parent.parentElement;
            }
            if (parent && (parent.id !== "" && parent.id !== "Unknown") && button.value.startsWith("Ping")) {
              button.click();
            }
          });
          //store logs between updates maybe
          var logs = document.querySelectorAll('p');
          logs.forEach(current_log => {
            if (current_log.id.endsWith("logs"))
            logs_for_categories[current_log.id]=current_log.innerHTML;
          });
    }

    function getcontainers(){
        
        try {
        $.ajax({
        url: './read_containers',
        type: 'POST',
        success: function(response) {
            //unsafe but works
            //console.log(response);
            makeTable(response);
            
        },
        error: function(error) {
            logging(error);
        }
        });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        
    };
    async function rebootContainer(containerID, element) {
        element.value = "Restarting...";
        try {
            $.ajax({
                url: './reboot_container',
                data: {id: containerID},
                type: 'POST',
                success: function(response) {
                    logging(containerID+' was rebooted!');
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        //make it look like the operation takes some time if it is too fast
        await smartSleep(500 + 50 * Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        element.value = "Restart";
    };
    function testsResults() {
        try {
            $.ajax({
                url: './tests_results',
                type: 'POST',
                success: function(response) {
                    logging("Tests results obtained: " + response);
                    setTestResults(response);
                    },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function get_complex_tests(){
        try {
            $.ajax({
                url: './get_complex_tests',
                type: 'GET',
                success: function(response) {
                    for (const element of response) {
                        try {
                        document.getElementById(element[3]+'-result').innerHTML=element[2];
                        } catch (exception_var) {
                            logging(exception_var);
                        }
                    }
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    async function runTests(container, element) {
        element.value = "Pinging the port...";
        try {
            $.ajax({
                url: './run_test',
                type: 'POST',
                data: {container: container},
                success: function(response) {
                    if (response==="") response = "No test was found for this component."; 
                    logging("test was ran with result"+response, element.parentElement.parentElement.parentElement.parentElement.parentElement.id+'-logs');
                    test_results[container] = response;
                    stored_pings_results[container] = response;
                    document.getElementById(container+'-result').innerHTML=response;
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        //make it look like the operation takes some time if it is too fast
        await smartSleep(500 + 50 * Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        element.value = "Ping the port...";
    }

    function load_db() {
        try {
            $.ajax({
                url: './load_db',
                type: 'POST',
                success: function(response) {
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function runComplexTests(test_element) {
        try {
            var oldtext = test_element.value;
            test_element.value = "Running " + test_element.value;
            let test_family = test_element.parentElement.querySelectorAll('input');
            let test_name = test_family[0].value;
            let dict_to_be_sent = {};
            dict_to_be_sent['test_name'] = test_name;
            test_family.forEach(el => {dict_to_be_sent[el.name]=el.value});
            delete dict_to_be_sent[test_element.name];
            $.ajax({
                url: './run_test_complex',
                type: 'POST',
                data: dict_to_be_sent,
                success: function(response) {
                    logging("test was ran",response);
                    document.getElementById(test_name+'-result').innerHTML=response;
                },
                error: function(error) {
                    logging(error);
                }
            });
            test_element.value = oldtext;
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function setTestResults(results) {
        test_results = results;
        try {
        test_results.forEach((element) => {
            test_results_divs[element[3]]=element[2];
        })
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function logging(logging_str, log_destination="see_logs") {
        if (log_destination==="") log_destination = "see_logs";
        console.log(logging_str);
        document.getElementById(log_destination).innerHTML += new Date().toLocaleString() + ' - ' + logging_str + '<br>';
        document.getElementById("see_logs").innerHTML += new Date().toLocaleString() + ' - ' + logging_str + '<br>';
    }

    const buttons = document.querySelectorAll('input[type="button"]');

    async function getSummary() {
        await smartSleep(1000);
        try {
            $.ajax({
                url: './get_summary_status',
                type: 'GET',
                success: function(response) {
                    for (const element of response) {
                        try {
                            document.getElementById(element[0]+'-status').innerHTML=element[0]+' - '+element[1];
                            } catch (e) {
                            if (e instanceof TypeError) {
                                return;
                            }
                            else {
                                logging(exception_var);
                            }
                    }
                }
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function getExtraData(url_of_resource, destination_element) {
        try {
        $.ajax({
          url: "./get_data_from_source",
          method: "GET",
          data: {url_of_resource: url_of_resource[1]},
          success: function(response) {
            renderContentInIframe(response, destination_element, url_of_resource[3]);
          },
          error: function(xhr, status, error) {
            var errorHtml = "<p>Error: Unable to fetch data from "+url_of_resource+" due to "+error+" with status "+status+"</p>";
            renderContentInIframe(errorHtml, destination_element);
          }
        });
      }
      catch (exception_var) {
        console.error(exception_var+", please kill me");
      }
    }
      
      function renderContentInIframe(content, destination_element, description_data) {
        var iframe = document.createElement('iframe');
        iframe.setAttribute("style", "width: 100%; height: 450px;");
        var description = document.createElement('div');
        description.innerHTML = description_data;
        destination_element.appendChild(description);
        destination_element.appendChild(iframe);
        var doc = iframe.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
      }

    function showTestResults() {
        if (test_results==null) {
            return;
            //not set yet
        }
        logging(test_results);
        try {
            test_results.forEach((element)=> {
            
            try {
                document.getElementById(element[3]).innerHTML=element[2];
            }
            catch (exception_var) {
                logging('An orphan test with the name '+element[3]+' gave a result of: ' +element[2]);
            } }) 
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function getTestResult(container) {
        //this is for complex tests only
        test_results.forEach((element)=> {
            try {
                if (element[3] == container) {
                    document.getElementById[container].innerHTML=element[2];
                }
            }
            catch (exception_var) {
                console.error(exception_var);
            }
        })
        return container;
    }
    
    function makeTable(containerdata) {
        const headerData = ["Disk Data I/0", "CPU%", "ContainerID (click for container-logs)", "Image", "Mem%", "Mem Used / Mem Max", "Container Name", "Network I/O", "Ports", "Running for / Exited since", "Size", "Status", "Restart", "Is alive test", "Last tests results"];
        //const rowData = containerdata.split('\n');
        //rowData.pop();
        /*
        {
    "Command":"\"bash -c \\'waitress-s…\"",
    "CreatedAt":"2023-10-30 17:08:24 +0100 CET",
    "Image":"fabriziomereu/snap4city_installation_generator:dev.1.3.2",
    "Labels":"desktop.docker.io/binds/0/Source=C:\\Users\\fabri\\Desktop\\tesi\\Mysql\\latest.sql,desktop.docker.io/binds/0/Target=/data/mysql/a.sql,com.docker.compose.depends_on=db:service_started:true,com.docker.compose.project.working_dir=C:\\Users\\fabri\\Desktop\\tesi,com.docker.compose.project.config_files=C:\\Users\\fabri\\Desktop\\tesi\\docker-compose.yml,com.docker.compose.image=sha256:20c7adabdd2daaa4e33c5c06dff7f79c9d179ba11ddc32dfcddb3ef33add782a,com.docker.compose.oneoff=False,com.docker.compose.version=2.22.0,desktop.docker.io/binds/0/SourceKind=hostFile,com.docker.compose.project=tesi,com.docker.compose.replace=c4f06aeebfcdaff8ce3a1155399f4d53dd5bb2bf732d8a9c613f6e32fa33761f,com.docker.compose.service=app,com.docker.compose.config-hash=c566ba9d96f83cd6c34d41a4e24419891686d2de2a9f781999e95f0119de7b7f,com.docker.compose.container-number=1",
    "LocalVolumes":"0",
    "Mounts":"/run/desktop/m…",
    "Networks":"tesi_default",
    "Ports":"0.0.0.0:80->80/tcp",
    "RunningFor":"2 days ago",
    "Size":"0B",
    "State":"exited",
    "Status":"Exited (255) 2 days ago",
    "BlockIO":"0B / 0B",
    "CPUPerc":"0.00%",
    "Container":"9b13642d3479",
    "MemPerc":"0.00%",
    "MemUsage":"0B / 0B",
    "Name":"app",
    "NetIO":"0B / 0B",
    "PIDs":"0"
    }*/

    function createTable(headerData, rowData, name_of_table_value) {
        const table = document.createElement("table");
        table.setAttribute("class", "table  table-striped table-bordered");
        table.setAttribute("style", "table-layout: fixed;")
        const thead = document.createElement("thead");
        thead.setAttribute("class", "thead-dark");
        const tbody = document.createElement("tbody");

        const headerRow = document.createElement("tr");
        headerData.forEach(headerText => {
            const th = document.createElement("th");
            th.setAttribute("class", "column");
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        rowData.forEach(rowValues => {
            const row = document.createElement("tr");
            var elements = Object.values(rowValues);
            var index_of_below_array = 0;
            elements.forEach(cellData => {
                const td = document.createElement("td");
                if (index_of_below_array === 3) {
                    var content_of_id_cell = '<a target="_blank" href="./container/'+cellData+'">'+cellData+'</a>';
                    td.innerHTML = content_of_id_cell;
                }
                else if (index_of_below_array === 20) {
                    var content_of_id_cell;
                    if (cellData === "running" != (elements[6] === "certbot/certbot"))
                        content_of_id_cell = cellData + '<span style="color: green;font-size: x-large;">●</span>';
                        else content_of_id_cell = cellData + '<span style="color: red;font-size: x-large;">●</span>';
                    td.innerHTML = content_of_id_cell;
                }
                else {
                    td.textContent = cellData;
                }
                row.appendChild(td);
                index_of_below_array = index_of_below_array + 1;
            });
            
            row.removeChild(row.childNodes[21]);
            row.removeChild(row.childNodes[16]);
            row.removeChild(row.childNodes[15]);
            row.removeChild(row.childNodes[13]);
            row.removeChild(row.childNodes[11]);
            row.removeChild(row.childNodes[8]);
            row.removeChild(row.childNodes[7]);
            row.removeChild(row.childNodes[5]);
            row.removeChild(row.childNodes[4]);
            row.removeChild(row.childNodes[2]);
            
            
            var rebootbutton = document.createElement("td");
            rebootbutton.innerHTML=`<input type="button" name="`+elements[12]+`" value="Restart" class="btn btn-primary" onclick="rebootContainer('`+elements[12]+`', this)"/>`;
            row.appendChild(rebootbutton);
            var testsbutton = document.createElement("td");
            testsbutton.innerHTML=`<input type="button" name="`+elements[12]+`" value="Ping the port..." class="btn btn-info" onclick="runTests('`+elements[12]+`', this)"/>`;
            row.appendChild(testsbutton);
            tbody.appendChild(row);
            var testresults = document.createElement("td");
            testresults.setAttribute('id',elements[12]+'-result');
            row.appendChild(testresults);

            tbody.appendChild(row);
            testresults.innerHTML=test_results_divs[row.childNodes[6].innerHTML];
            if (testresults.innerHTML == "undefined") {
                testresults.innerHTML = "No tests found";
            }
            
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        const box = document.createElement("div");
        box.setAttribute("class", "p-5 text-center");
        box.setAttribute("style", "border-radius: 3rem; background-color: "+cg.next().value)
        const name_of_table = document.createElement("h1");
        name_of_table.setAttribute("class", "text-body-emphasis");
        name_of_table.innerHTML = name_of_table_value;
        box.appendChild(name_of_table);
        box.appendChild(table);
        return table;
    }

    
    const tableContainer = document.getElementById("table-container");
    tableContainer.innerText="";
    containerdata.sort((a, b) => {
        const nameA = a.Name.toUpperCase();
        const nameB = b.Name.toUpperCase();
    
        if (nameA < nameB) {
            return -1;
        }
        if (nameA > nameB) {
            return 1;
        }
        return 0;
    });
    
    

    //const table = createTable(headerData, containerdata);


    const categorizedData = {};

    containerdata.forEach(item => {
        const name = item.Name;
        let category = 'Unknown';
        for (const key in lookupTable) {
            if (name.startsWith(key.replace('*', ''))) {
            category = lookupTable[key];
            break;
            }
        }
        if (!categorizedData[category]) {
            categorizedData[category] = [];
        }
        categorizedData[category].push(item);
    });

    //console.log(categorizedData);
    
    const cg = colorGenerator();
    jQuery.each(categorizedData, function (i, val) {
        if (true) {
            const box = document.createElement("div");
            box.setAttribute("class", "p-5 text-center");
            box.setAttribute("style", "border-radius: 3rem; background-color: "+cg.next().value);
            box.setAttribute("id",i);
            if (opened_categories.has(i)) box.style.display = "block"; else box.style.display = "none";
            
            //box.setAttribute("style", "display: none;");
            //correctVisibility(box);
            const centerer = document.createElement("div");
            centerer.setAttribute("style", "text-align: center");
            const name_of_table = document.createElement("h1");
            name_of_table.setAttribute("class", "btn btn-dark btn-lg");
            name_of_table.setAttribute("style", "text-align: center");
            name_of_table.setAttribute("onclick", "collapse_category('"+i+"')");
            name_of_table.setAttribute("id", i+"-status");
            name_of_table.innerHTML = i;
            centerer.appendChild(name_of_table);
            tableContainer.appendChild(centerer);
            box.appendChild(createTable(headerData, val, i));
            const parser = new DOMParser();
            extra_data_locations.filter(innerArray => innerArray[0] === i).forEach(innerArray => {
                getExtraData(innerArray, box);
            });
            if (add_complex_test_table_depending_on_category(i)) {
                const complex_tests = document.createElement("div");
                complex_tests.setAttribute("style", "background-color: white;");
                complex_tests.innerHTML=add_complex_test_table_depending_on_category(i);
                box.appendChild(complex_tests);
            }
            tableContainer.appendChild(box);
            const category_logs = document.createElement("p");
            category_logs.setAttribute("id", i+"-logs");
            category_logs.setAttribute("class", "ui-widget-header");
            category_logs.setAttribute("style", "text-align: left;");
            box.appendChild(category_logs);
            if (logs_for_categories[i+"-logs"]) category_logs.innerHTML=logs_for_categories[i+"-logs"];
            }
            else console.log("Skipped unmanaged containers");
            
    });
    getSummary();
    get_complex_tests();
    //tableContainer.appendChild(table);
}

function collapse_category(category_element_id) {
    element=document.getElementById(category_element_id);
    if (element.style.display === "none") {
        element.style.display = "block";
        opened_categories.add(category_element_id);
    } else {
        element.style.display = "none";
        opened_categories.delete(category_element_id);
    }
  };


function add_complex_test_table_depending_on_category(category) {
    var final_str = "";
    button_data.forEach((element) => {
        if (element["type"] === category) {final_str += element["data"]};
    });
    return final_str;
}

function* colorGenerator() {
    const colors = ['#00abff', '#cf71ff', '#fff466', '#3cb032', '#ff8a38'];
    let index = 0;
  
    while (true) {
      yield colors[index % colors.length];
      index++;
    }
  }
</script>


<nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
  <div class="collapse navbar-collapse container-fluid" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="navbar-brand">$#base-hostname#$</a>
      </li>
    </ul>

    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <form action="generate_pdf" method="POST">
             <input type="submit" class="btn btn-info" value="Generate full logs" />
        </form>
      </li>
    </ul>
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="navbar-brand">SnapSentinel: Platform Process Monitoring and Control</a>
      </li>
    </ul>
    <ul class="navbar-nav mr-auto">
        <li class="nav-item"  style="padding-right: 0.5em;">
          <button id="buttonForUpdates" class="btn btn-danger" onClick="toggleUpdate()">Stop refresh</label>
        </li>
        <li class="nav-item">
          <button id="updatenow" class="btn btn-danger" onClick="update_routine()">Refresh now</label>
        </li>
      <li class="nav-item">
        <div id="last-update" class="nav-link"></div>
      </li>
    </ul>
  </div>
</nav>

<div id="output" class="main">
    <br>
    <div id="table-container">
    </div>
</div>
    <div id="notDraggable" class="ui-widget-content">
        <p>Console Log</p>
        <p class="ui-widget-header" id="see_logs"></p>
    </div>

<nav class="navbar sticky-bottom bg-body-tertiary">
  <div class="container-fluid">
    <a class="navbar-brand" href="mailto: replaceme">Supporto? Mandaci una mail!</a>
    <a class="navbar-brand" href="#">
      <img src="./{{ url_for('static', filename = 'snap4.png') }}" alt="Logo" width="80px" height="45px" class="d-inline-block align-text-top">
    </a>
  </div>
  
</nav>
<style>
    table th, table td {
      max-width: 200px;
      overflow: auto;
    }
    .main {
        position:relative;
    }
    .ui-widget-header {
        background-color: white;
        border-width: unset;
        border-color: black;
        border-style: solid;
        overflow: scroll;
        max-height: 240px;
    }
  #draggable { max-width: 700px; max-height: 300px; padding: 0.5em; float: left; margin: 0 10px 10px 0; border-style: solid; border-color: blue; background: white;}
  #draggable p { cursor: move; }
</style>
{% endblock %}
