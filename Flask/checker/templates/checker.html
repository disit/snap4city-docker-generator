{% extends "main.html" %}
{% block title %}SnapSentinel{% endblock %}
{% block head %}
{{ super() }}

{% endblock %}
{% block content %}
<script>
    var donotupdate = false;
    var test_results;
    var test_results_divs = {};
	var data_tables = {};
    const extra_data_locations = [
        {%for item in extra_data%}['{{item[0]}}', '{{item[1]}}', '{{item[2]}}', '{{item[3]}}'],
        {% endfor %}
    ];
	var less_columns = false;
	
	var dict_of_hidden_columns = {};
	var container_rows = {};
    var iframes = {};
    var closed_categories = new Set();
    var logs_for_categories = {};
    var stored_pings_results = {};
    var button_data = [
        {%for element in extra%}
        {'data':`<div class="row align-items-start"><div class="col"><input type="button" name="{{element[1]}}" id="{{element[1]}}" value="{{element[1]}}" class="form-control" onclick="runComplexTests(this, '{{element[7]}}')" style="background: {{element[4]}}; color: {{element[6]}}"/>
                <div>{{element[5]|safe}}</div></div>
                {%if element[3] != None%}{% for element_2 in element[3].split(';') %}{% set parts = element_2.split(':') %}
                    <input type="{{ parts[0] }}" id="{{ parts[2] }}-{{element[1]}}" name="{{ parts[2] }}" placeholder="{{parts[1]}}" class="form-control"></div>{% endfor %}{%endif%}
                <div class="col" id="{{element[1]}}-result">No data yet...</div></div>`, 'type':`{{element[7]|safe}}`},
        {%endfor%}
    ];

    const lookupTable = {
        {%for item in categories%}'{{item[0]}}': ['{{item[1]}}','{{item[2]|safe}}','{{item[3]|safe}}'],
        {% endfor %}'nothing': 'nothing'
    };

    function toggleUpdate() {
        if (donotupdate) {
            document.getElementById("buttonForUpdates").innerHTML = "Stop containers refresh";
            donotupdate = false;
        }
        else {
            document.getElementById("buttonForUpdates").innerHTML = "Resume containers refresh";
            donotupdate = true;
            //after 30 minutes, resume updates in case user forgot to turn them on
            smartSleep(1800000);
            document.getElementById("buttonForUpdates").innerHTML = "Stop containers refresh";
            donotupdate = false;
        }
    }

    function smartSleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    $( function() {
        $( "#draggable" ).draggable({ cancel: "p.ui-widget-header" });
    } );
    
    $(document).ready(async function askcontainers() {
        while (1) {
            if (!donotupdate) {
                update_routine();
                }
            await smartSleep(120000);
        }
    });
	
	


    function update_routine() {
        getcontainers();
        testsResults();
        showTestResults();
		$("table[id^='table-']").DataTable();
		document.getElementById("last-update").innerHTML = "Last update: " + new Date().toLocaleString();
        cg = colorGenerator();
        var buttons = document.querySelectorAll('input[type="button"]');
        buttons.forEach(button => {
            let parent = button.parentElement;
            for (let i = 1; i < 5 && parent; i++) {
                parent = parent.parentElement;
            }
            if (parent && (parent.id !== "" && parent.id !== "Unknown") && button.value.startsWith("Check")) {
                button.click();
            }
        });
        //store logs between updates maybe
        var logs = document.querySelectorAll('p');
        logs.forEach(current_log => {
            if (current_log.id.endsWith("logs"))
            logs_for_categories[current_log.id]=current_log.innerHTML;
        });
    }

    function getcontainers(){
        
        try {
        $.ajax({
        url: './read_containers',
        type: 'POST',
        success: function(response) {
            //unsafe but works
            //console.log(response);
            makeTable(response);
            
        },
        error: function(error) {
            logging(error);
        },
        timeout: 7000
        });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        
    };
    async function rebootContainer(containerID, element) {
        if (confirm('You are about to reboot a container: this action requires additional confirmation')) {
            element.value = "Restarting...";
            try {
                $.ajax({
                    url: './reboot_container',
                    data: {id: containerID},
                    type: 'POST',
                    success: function(response) {
                        logging(containerID+' was rebooted!', element.parentElement.parentElement.parentElement.parentElement.parentElement.id+'-logs');
                    },
                    error: function(error) {
                        logging(error);
                    },
                    timeout: 7000
                });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        //make it look like the operation takes some time if it is too fast
        await smartSleep(500 + 50 * Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        element.value = "Restart";
        } else {
            // Do nothing!
            return;
        }
        
    };
    function testsResults() {
        try {
            $.ajax({
                url: './tests_results',
                type: 'POST',
                success: function(response) {
                    logging("Tests results obtained: " + response);
                    setTestResults(response);
                    },
                error: function(error) {
                    logging(error);
                },
                timeout: 7000
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function sendRequest(method) {
        const url = './forward';
        let options = {
            url: url,
            method: method,
            success: function(data, textStatus, jqXHR) {
                return data;
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $('#response').text(`Error: ${textStatus}\n${errorThrown}`);
            }
        };

        if (method === 'POST' || method === 'PUT') {
            options.contentType = 'application/json';
            options.data = JSON.stringify({ key: 'value' });
        }

        $.ajax(options);
    }

    function get_complex_tests(){
        try {
            $.ajax({
                url: './get_complex_tests',
                type: 'GET',
                success: function(response) {
                    for (const element of response) {
                        try {
                        document.getElementById(element[3]+'-result').innerHTML=element[2];
                        } catch (exception_var) {
                            logging("Error in obtaining complex tests: "+ exception_var + ' - ' + element);
                        }
                    }
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                },
                timeout: 7000
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    async function runTests(container, element, location) {

        const currentTime = Date.now();
        const button = event.target;

        // Initialize the last execution time if it doesn't exist
        if (!button.lastExecutionTime) {
            button.lastExecutionTime = 0;
        }

        // Check if 3 seconds have passed since the last execution
        if (currentTime - button.lastExecutionTime >= 3000) {

            // Update the last execution time
            button.lastExecutionTime = currentTime;
        } else {
            alert("You cannot perform this action, wait a few seconds.");
            return;
        }

        element.value = "Checking the port...";
        try {
            $.ajax({
                url: './run_test',
                type: 'POST',
                data: {container: container},
                success: function(response) {
                    if (response==="") response = "No test was found for this component."; 
                    logging("<b>" + element.name + "</b> had its port checked and the result was: "+response, location+'-logs');
                    test_results[container] = response;
                    stored_pings_results[container] = response;
                    //document.getElementById(container+'-result').innerHTML=response;
                },
                error: function(error) {
                    logging(error);
                },
                timeout: 7000
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        //make it look like the operation takes some time if it is too fast
        await smartSleep(500 + 50 * Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        element.value = "Check the port...";
    }

    function load_db() {
        try {
            $.ajax({
                url: './load_db',
                type: 'POST',
                success: function(response) {
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                },
                timeout: 7000
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    async function runComplexTests(test_element, category) {
        const currentTime = Date.now();
        const button = event.target;

        // Initialize the last execution time if it doesn't exist
        if (!button.lastExecutionTime) {
            button.lastExecutionTime = 0;
        }

        // Check if 3 seconds have passed since the last execution
        if (currentTime - button.lastExecutionTime >= 3000) {

            // Update the last execution time
            button.lastExecutionTime = currentTime;
        } else {
            alert("You cannot perform this action, wait a few seconds.");
            return;
        }
        try {
            var oldtext = test_element.name;
            test_element.value = "Running " + test_element.value;
            let test_family = test_element.parentElement.querySelectorAll('input');
            let test_name = test_family[0].value;
            let dict_to_be_sent = {};
            dict_to_be_sent['test_name'] = oldtext;
            test_family.forEach(el => {dict_to_be_sent[el.name]=el.value});
            delete dict_to_be_sent[test_element.name];
            $.ajax({
                url: './run_test_complex',
                type: 'POST',
                data: dict_to_be_sent,
                success: function(response) {
                    logging(category + " - Complex test was ran: "+response, category+"-logs");
                    
                    document.getElementById(oldtext+'-result').innerHTML=response;
                },
                error: function(error) {
                    logging(oldtext + " - " + error.statusText ,category+"-logs");
                },
                timeout: 7000
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        
        await smartSleep(500 + 50 * Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random()));
        test_element.value = oldtext;
    }

    function setTestResults(results) {
        test_results = results;
        try {
        test_results.forEach((element) => {
            test_results_divs[element[3]]=element[2];
        })
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function logging(logging_str, log_destination="see_logs") {
        if (log_destination==="") log_destination = "see_logs";
        document.getElementById(log_destination).innerHTML += new Date().toLocaleString() + ' - ' + logging_str + '<br>';
        if (log_destination!="see_logs")document.getElementById("see_logs").innerHTML += new Date().toLocaleString() + ' - ' + logging_str + '<br>';
    }

    const buttons = document.querySelectorAll('input[type="button"]');

    async function getSummary() {
        await smartSleep(1000);
        try {
            $.ajax({
                url: './get_summary_status',
                type: 'GET',
                success: function(response) {
                    for (const element of response) {
                        try {
                            document.getElementById(element[0]+'-status').innerHTML=element[0]+' - '+element[1];
                            } catch (e) {
                            if (e instanceof TypeError) {
                                return;
                            }
                            else {
                                logging(exception_var);
                            }
                    }
                }
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                },
                timeout: 7000
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function getExtraData(url_of_resource, destination_element) {
        try {
        $.ajax({
          url: "./get_data_from_source",
          method: "GET",
          data: {url_of_resource: url_of_resource[1]},
          success: function(response) {
            renderContentInIframe(response, destination_element, url_of_resource[3]);
          },
          error: function(xhr, status, error) {
            var errorHtml = "<p>Error: Unable to fetch data from "+url_of_resource+" due to "+error+" with status "+status+"</p>";
            renderContentInIframe(errorHtml, destination_element);
          },
          timeout: 7000
        });
      }
      catch (exception_var) {
        console.error(exception_var+", please kill me");
      }
    }
      
      function renderContentInIframe(content, destination_element, description_data) {
        var iframe = document.createElement('iframe');
        iframe.setAttribute("style", "width: 100%; height: 450px;");
        var description = document.createElement('div');
        description.innerHTML = description_data;
        destination_element.appendChild(description);
        destination_element.appendChild(iframe);
        var doc = iframe.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
      }

    function showTestResults() {
        if (test_results==null) {
            return;
            //not set yet
        }
        logging(test_results);
        try {
            test_results.forEach((element)=> {
            
            try {
                document.getElementById(element[3]+'-result').innerHTML=element[2];
            }
            catch (exception_var) {
                logging('An orphan test with the name '+element[3]+' gave a result of: ' +element[2]);
            } }) 
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function getTestResult(container) {
        //this is for complex tests only
        test_results.forEach((element)=> {
            try {
                if (element[3] == container) {
                    document.getElementById[container].innerHTML=element[2];
                }
            }
            catch (exception_var) {
                console.error(exception_var);
            }
        })
        return container;
    }
    
    function makeTable(containerdata) {
        const headerData = ["I/O" ,"CPU%", "Command", "ContainerID (click for container-logs)", "Created at", "ID", "Image", "Labels", "Local Volumes", "Mem%", "Mem Used / Mem Max", "Mounts", "Container Name", "Names", "Network I/O", "Networks", "PIDs", "Ports", "Running for / Exited since", "Size", "State", "Status", "Restart", "Is alive test", "Last test results", "Contacts", "Location", "Toggle update for this component"];
        //const rowData = containerdata.split('\n');
        //rowData.pop();
        /*
        {
    "Command":"\"bash -c \\'waitress-s…\"",
    "CreatedAt":"2023-10-30 17:08:24 +0100 CET",
    "Image":"fabriziomereu/snap4city_installation_generator:dev.1.3.2",
    "Labels":"desktop.docker.io/binds/0/Source=C:\\Users\\fabri\\Desktop\\tesi\\Mysql\\latest.sql,desktop.docker.io/binds/0/Target=/data/mysql/a.sql,com.docker.compose.depends_on=db:service_started:true,com.docker.compose.project.working_dir=C:\\Users\\fabri\\Desktop\\tesi,com.docker.compose.project.config_files=C:\\Users\\fabri\\Desktop\\tesi\\docker-compose.yml,com.docker.compose.image=sha256:20c7adabdd2daaa4e33c5c06dff7f79c9d179ba11ddc32dfcddb3ef33add782a,com.docker.compose.oneoff=False,com.docker.compose.version=2.22.0,desktop.docker.io/binds/0/SourceKind=hostFile,com.docker.compose.project=tesi,com.docker.compose.replace=c4f06aeebfcdaff8ce3a1155399f4d53dd5bb2bf732d8a9c613f6e32fa33761f,com.docker.compose.service=app,com.docker.compose.config-hash=c566ba9d96f83cd6c34d41a4e24419891686d2de2a9f781999e95f0119de7b7f,com.docker.compose.container-number=1",
    "LocalVolumes":"0",
    "Mounts":"/run/desktop/m…",
    "Networks":"tesi_default",
    "Ports":"0.0.0.0:80->80/tcp",
    "RunningFor":"2 days ago",
    "Size":"0B",
    "State":"exited",
    "Status":"Exited (255) 2 days ago",
    "BlockIO":"0B / 0B",
    "CPUPerc":"0.00%",
    "Container":"9b13642d3479",
    "MemPerc":"0.00%",
    "MemUsage":"0B / 0B",
    "Name":"app",
    "NetIO":"0B / 0B",
    "PIDs":"0"
    }*/

    function createTable(headerData, rowData, name_of_table_value) {
        const table = document.createElement("table");
        table.setAttribute("id", "table-"+name_of_table_value.replace(/\s+/g, ''));
        table.setAttribute("class", "table  table-striped table-bordered");
        table.setAttribute("style", "table-layout: fixed; background-color: white;");
        const thead = document.createElement("thead");
        thead.setAttribute("class", "thead-dark");
        const tbody = document.createElement("tbody");

        const headerRow = document.createElement("tr");
        headerData.forEach(headerText => {
            const th = document.createElement("th");
            th.setAttribute("class", "column");
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        rowData.forEach(rowValues => {
			if (container_rows[rowValues["Name"]]) {
				console.log("shouldn't update", rowValues["Name"]);
				tbody.appendChild(container_rows[rowValues["Name"]]);
				return;
			}
            const row = document.createElement("tr");
            row.setAttribute("name", rowValues["Name"]);            
            var elements = Object.values(rowValues);
            var index_of_below_array = 0;
            elements.forEach(cellData => {
                const td = document.createElement("td");
                if (index_of_below_array === 3) {
                    var content_of_id_cell = '<a target="_blank" href="./container/'+cellData+'">'+cellData+'</a>';
                    td.innerHTML = content_of_id_cell;
                }
                else if (index_of_below_array === 20) {
                    var content_of_id_cell;
                    if (cellData === "running" != (elements[6] === "certbot/certbot"))
                        content_of_id_cell = cellData + '<span style="color: green;font-size: x-large;">●</span>';
                        else content_of_id_cell = cellData + '<span style="color: red;font-size: x-large;">●</span>';
                    td.innerHTML = content_of_id_cell;
                }
                else {
                    td.textContent = cellData;
                }
                row.appendChild(td);
                index_of_below_array = index_of_below_array + 1;
            });
            /*
            row.removeChild(row.childNodes[21]);
            row.removeChild(row.childNodes[16]);
            row.removeChild(row.childNodes[15]);
            row.removeChild(row.childNodes[13]);
            row.removeChild(row.childNodes[11]);
            row.removeChild(row.childNodes[10]);
            row.removeChild(row.childNodes[8]);
            row.removeChild(row.childNodes[7]);
            row.removeChild(row.childNodes[5]);
            row.removeChild(row.childNodes[4]);
            row.removeChild(row.childNodes[2]);
            row.removeChild(row.childNodes[0]);
            */
            
            var rebootbutton = document.createElement("td");
            rebootbutton.innerHTML=`<input type="button" name="`+elements[12]+`" value="Restart" class="btn btn-primary" onclick="rebootContainer('`+elements[12]+`', this, '`+name_of_table_value+`')"/>`;
            row.appendChild(rebootbutton);
            var testsbutton = document.createElement("td");
            testsbutton.innerHTML=`<input type="button" name="`+elements[12]+`" value="Check the port..." class="btn btn-info" onclick="runTests('`+elements[12]+`', this, '`+name_of_table_value+`')"/>`;
            row.appendChild(testsbutton);
            tbody.appendChild(row);
            var testresults = document.createElement("td");
            testresults.setAttribute('id',elements[12]+'-result');

            var some_value;
                for (const key in lookupTable) {
                    if (rowValues["Name"].startsWith(key.replace('*', ''))) {
                        some_value = lookupTable[key];
                    break;
                    }
                }
            if (!some_value) some_value = ["","Failure to retrieve contacts", "Failure to retrieve location"];
            

            var in_case_of_problems = document.createElement("td");
            in_case_of_problems.innerHTML=some_value[1];
            
            var location_of_component = document.createElement("td");
            location_of_component.innerHTML=some_value[2];
            in_case_of_problems.innerHTML=some_value[1];

            row.appendChild(testresults);
            row.appendChild(in_case_of_problems);
            row.appendChild(location_of_component);
            
			var do_not_update_this_td = document.createElement("td");
			var do_not_update_this = document.createElement("input");
			do_not_update_this.setAttribute("onclick", "toggle_update_this_line(this)");
			do_not_update_this.setAttribute("class", "btn btn-info");
			do_not_update_this.setAttribute("type", "button");
			do_not_update_this.setAttribute("value", "Stop this component from refreshing");
			do_not_update_this_td.appendChild(do_not_update_this);
			row.appendChild(do_not_update_this_td);
			//container_rows[rowValues["Name"]]=row;
            tbody.appendChild(row);
            testresults.innerHTML=test_results_divs[row.childNodes[6].innerHTML];
            if (testresults.innerHTML == "undefined") {
                testresults.innerHTML = "No tests found";
            }

            
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        const box = document.createElement("div");
        box.setAttribute("class", "p-5 text-center");
        box.setAttribute("style", "border-radius: 3rem; background-color: "+cg.next().value)
        const name_of_table = document.createElement("h1");
        name_of_table.setAttribute("class", "text-body-emphasis");
        name_of_table.innerHTML = name_of_table_value;
        box.appendChild(name_of_table);
        box.appendChild(table);
        return table;
    }

    
    const tableContainer = document.getElementById("table-container");
	tableContainer.setAttribute("style", "display: flex; flex-wrap: wrap;")
    tableContainer.innerText="";
    containerdata.sort((a, b) => {
        const nameA = a.Name.toUpperCase();
        const nameB = b.Name.toUpperCase();
    
        if (nameA < nameB) {
            return -1;
        }
        if (nameA > nameB) {
            return 1;
        }
        return 0;
    });
    
    

    //const table = createTable(headerData, containerdata);


    const categorizedData = {};

    containerdata.forEach(item => {
        const name = item.Name;
        let category = 'Unknown';
        for (const key in lookupTable) {
            if (name.startsWith(key.replace('*', ''))) {
            category = lookupTable[key][0];
            break;
            }
        }
        if (!categorizedData[category]) {
            categorizedData[category] = [];
        }
        categorizedData[category].push(item);
    });

    //console.log(categorizedData);
    
    const cg = colorGenerator();
	var something = Object.keys(categorizedData).sort();
	document.getElementById("category_menu").innerHTML="";
    jQuery.each(something, function (item, val_2) {
        if (true) {
			var val = categorizedData[val_2];
			var i = val_2;
            const box = document.createElement("div");
            box.setAttribute("class", "p-5 text-center");
            box.setAttribute("style", "border-radius: 3rem; background-color: "+cg.next().value);
            box.setAttribute("id",i);
            //if (!closed_categories.has(i)) box.style.display = "block"; else box.style.display = "none";
            
            //box.setAttribute("style", "display: none;");
            //correctVisibility(box);
            const centerer = document.createElement("div");
            //centerer.setAttribute("style", "text-align: center");
			centerer.setAttribute("name", i);
            const name_of_table = document.createElement("h1");
            name_of_table.setAttribute("class", "btn btn-light btn-lg");
            name_of_table.setAttribute("onclick", "collapse_category('"+i+"', this)");
            name_of_table.setAttribute("id", i+"-status");
            name_of_table.innerHTML = i;
			var menupage = document.getElementById("category_menu");
			menupage.appendChild(name_of_table);
            //centerer.appendChild(name_of_table);
            var div_for_category_name = document.createElement("h1");
            div_for_category_name.innerHTML=i;
            tableContainer.appendChild(centerer);
            box.appendChild(div_for_category_name);
            box.appendChild(createTable(headerData, val, i));
            let a = 'table-'+i.replace(/\s+/g, '');
            const parser = new DOMParser();
            extra_data_locations.filter(innerArray => innerArray[0] === i).forEach(innerArray => {
                getExtraData(innerArray, box);
            });
            if (add_complex_test_table_depending_on_category(i)) {
                const complex_tests = document.createElement("div");
                complex_tests.setAttribute("style", "background-color: white;");
                complex_tests.innerHTML=add_complex_test_table_depending_on_category(i);
                box.appendChild(complex_tests);
            }
            centerer.appendChild(box);
            const category_logs = document.createElement("p");
            category_logs.setAttribute("id", i+"-logs");
            category_logs.setAttribute("class", "ui-widget-header");
            category_logs.setAttribute("style", "text-align: left; min-height: 250px;");
            box.appendChild(category_logs);
            if (logs_for_categories[i+"-logs"]) category_logs.innerHTML=logs_for_categories[i+"-logs"];
            }
            else console.log("Skipped unmanaged containers");
            
    });
    getSummary();
    get_complex_tests();
    data_tables=$("table[id^='table-']").DataTable(dict_of_hidden_columns);
	//if (less_columns) [0, 2, 4, 5, 6, 7, 8, 11, 13, 15, 16, 17, 19].forEach(function(index) {data_tables.column(index).visible(false)});
        
    //tableContainer.appendChild(table);
}

function toggle_update_this_line(component) {
	if (container_rows[component.parentElement.parentElement.getAttribute("name")]) {
		delete container_rows[component.parentElement.parentElement.getAttribute("name")];
		component.value = "Stop refresh";
	}
	else {
		component.value = "Resume refresh";
		container_rows[component.parentElement.parentElement.getAttribute("name")] = component.parentElement.parentElement;
	}
	console.log("flipped", component.parentElement.parentElement.getAttribute("name"));
}

function collapse_category(category_element_id, button) {
    element=document.getElementById(category_element_id);
    if (element.style.display === "none") {
		button.className="btn btn-light btn-lg";
        element.style.display = "block";
        closed_categories.delete(category_element_id);
    } else {
		button.className="btn btn-dark btn-lg";
        element.style.display = "none";
        closed_categories.add(category_element_id);
    }
  };


function toggle_hide_extra_columns(button) {
	less_columns = !less_columns;
	if (less_columns) {
		button.innerHTML = "Show additional columns";
		dict_of_hidden_columns={columnDefs:[{target: 0, visible: false},{target: 2, visible: false},{target: 4, visible: false},{target: 5, visible: false},{target: 6, visible: false},{target: 7, visible: false},{target: 8, visible: false},{target: 11, visible: false},{target: 13, visible: false},{target: 15, visible: false},{target: 16, visible: false},{target: 17, visible: false},{target: 19, visible: false}]};
	}
	else {
		dict_of_hidden_columns={retrieve: true};
		button.innerHTML = "Hide additional columns";
	}
	update_routine();
}

function add_complex_test_table_depending_on_category(category) {
    var final_str = "";
    button_data.forEach((element) => {
        if (element["type"] === category) {final_str += element["data"]};
    });
    return final_str;
}

function* colorGenerator() {
    const colors = ['#00abff', '#cf71ff', '#fff466', '#3cb032', '#ff8a38'];
    let index = 0;
  
    while (true) {
      yield colors[index % colors.length];
      index++;
    }
  }
</script>


<nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
  <div class="collapse navbar-collapse container-fluid" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="navbar-brand">$#base-url#$</a>
      </li>
    </ul>

    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <form action="generate_pdf" method="POST">
             <input type="submit" class="btn btn-info" value="Generate full logs" />
        </form>
      </li>
    </ul>
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="navbar-brand">SnapSentinel: Platform Process Monitoring and Control</a>
      </li>
    </ul>
    <ul class="navbar-nav mr-auto">
        <li class="nav-item"  style="padding-right: 0.5em;">
          <button id="buttonForUpdates" class="btn btn-danger" onClick="toggleUpdate()">Stop refresh</label>
        </li>
        <li class="nav-item" style="padding-right: 0.5em;">
          <button id="updatenow" class="btn btn-danger" onClick="update_routine()">Refresh now</label>
        </li>
        <li class="nav-item">
          <button id="toggle_columns" class="btn btn-danger" onClick="toggle_hide_extra_columns(this)">Hide unimportant columns</label>
        </li>
      <li class="nav-item">
        <div id="last-update" class="nav-link"></div>
      </li>
    </ul>
  </div>
</nav>

<div id="output" class="main">
    <br>
	<div id="category_menu" class="category_menu">
		
    </div>
    <div id="table-container">
		
</div>
    <div id="notDraggable" class="ui-widget-content">
        <p>Console Log</p>
        <p class="ui-widget-header" id="see_logs"></p>
    </div>

<nav class="navbar sticky-bottom bg-body-tertiary">
  <div class="container-fluid">
    <a class="navbar-brand" href="mailto: replaceme">Supporto? Mandaci una mail!</a>
    <a class="navbar-brand" href="#">
      <img src="./{{ url_for('static', filename = 'snap4.png') }}" alt="Logo" width="80px" height="45px" class="d-inline-block align-text-top">
    </a>
  </div>
  
</nav>
<style>
	.category_menu {
		display: flex;
		justify-content: space-evenly;
	}

    .tooltip-inner {
        user-select: text;
      }

    table th, table td {
      max-width: 200px;
      overflow: auto;
    }
    .main {
        position:relative;
    }
    .ui-widget-header {
        background-color: white;
        border-width: unset;
        border-color: black;
        border-style: solid;
        overflow: scroll;
        max-height: 240px;
    }
  #draggable { max-width: 700px; max-height: 300px; padding: 0.5em; float: left; margin: 0 10px 10px 0; border-style: solid; border-color: blue; background: white;}
  #draggable p { cursor: move; }
</style>
{% endblock %}
