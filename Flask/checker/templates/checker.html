{% extends "main.html" %}
{% block title %}DeMoTeC{% endblock %}
{% block head %}
{{ super() }}

{% endblock %}
{% block content %}
<script>
    var test_results;
    var test_results_divs = {};
    const extra_data_locations = [
        {%for item in extra_data%}['{{item[0]}}', '{{item[1]}}'],
        {% endfor %}
    ];
    var iframes = {};
    var button_data = [
        {%for element in extra%}
        {'data':`<document><input type="button" name="{{element[1]}}" id="{{element[1]}}" value="{{element[1]}}" class="form-control" onclick="runComplexTests(this)" style="background: {{element[4]}}; color: {{element[6]}}"/>
                <div>{{element[5]|safe}}</div>
                {%if element[3] != None%}
                {% for element_2 in element[3].split(';') %}{% set parts = element_2.split(':') %}
                    <input type="{{ parts[0] }}" id="{{ parts[2] }}-{{element[1]}}" name="{{ parts[2] }}" placeholder="{{parts[1]}}" class="form-control">
                {% endfor %}{%endif%}
                <div id="{{element[1]}}-result"></div></document>`, 'type':`{{element[7]|safe}}`},
        {%endfor%}
    ];

    const lookupTable = {
        {%for item in categories%}'{{item[0]}}': '{{item[1]}}',
        {% endfor %}'nothing': 'nothing'
    };

    function smartSleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    $( function() {
        $( "#draggable" ).draggable({ cancel: "p.ui-widget-header" });
    } );
    
    $(document).ready(async function askcontainers() {
    
        while (1) {
            if (!document.getElementById("freezecontainers").checked) {
                getcontainers();
                testsResults();
                showTestResults();
                cg = colorGenerator();
                }
            await smartSleep(120000);
        }
    });
    function getcontainers(){
        
        try {
        $.ajax({
        url: 'read_containers',
        type: 'POST',
        success: function(response) {
            //unsafe but works
            //console.log(response);
            makeTable(response);
            
        },
        error: function(error) {
            logging(error);
        }
        });
        }
        catch (exception_var) {
            logging(exception_var);
        }
        
    };
    function rebootContainer(containerID) {
        try {
            $.ajax({
                url: 'reboot_container',
                data: {id: containerID},
                type: 'POST',
                success: function(response) {
                    logging(containerID+' was rebooted!');
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };
    function testsResults() {
        try {
            $.ajax({
                url: 'tests_results',
                type: 'POST',
                success: function(response) {
                    logging("tests results obtained",response);
                    setTestResults(response);
                    },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function runTests(container) {
        try {
            $.ajax({
                url: 'run_test',
                type: 'POST',
                data: {container: container},
                success: function(response) {
                    logging("test was ran",response);
                    document.getElementById(container+'-result').innerHTML=response;
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function load_db() {
        try {
            $.ajax({
                url: 'load_db',
                type: 'POST',
                success: function(response) {
                    logging(response);
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function runComplexTests(test_element) {
        try {
            let test_family = test_element.parentElement.querySelectorAll('input');
            let test_name = test_family[0].value;
            let dict_to_be_sent = {};
            dict_to_be_sent['test_name'] = test_name;
            test_family.forEach(el => {dict_to_be_sent[el.name]=el.value});
            delete dict_to_be_sent[test_element.name];
            $.ajax({
                url: 'run_test_complex',
                type: 'POST',
                data: dict_to_be_sent,
                success: function(response) {
                    logging("test was ran",response);
                    document.getElementById(test_name+'-result').innerHTML=response;
                },
                error: function(error) {
                    logging(error);
                }
            });
        }
        catch (exception_var) {
            logging(exception_var);
        }
    }

    function setTestResults(results) {
        test_results = results;
        try {
        test_results.forEach((element) => {
            test_results_divs[element[3]]=element[2];
        })
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function logging(logging_str) {
        console.log(logging_str);
        document.getElementById("see_logs").innerHTML += logging_str + '<br>';
    }

    function getExtraData(url_of_resource, destination_element) {
        try {
        // Make AJAX request using jQuery
        $.ajax({
          url: "get_data_from_source",
          method: "GET",
          data: {url_of_resource: url_of_resource},
          success: function(response) {
            // If the request was successful, render the content in an iframe
            renderContentInIframe(response, destination_element);
          },
          error: function(xhr, status, error) {
            // If the request failed, render an error message in an iframe
            var errorHtml = "<p>Error: Unable to fetch data from "+url_of_resource+" due to "+error+" with status "+status+"</p>";
            renderContentInIframe(errorHtml, destination_element);
          }
        });
      }
      catch (exception_var) {
        console.error(exception_var+", please kill me");
      }
    }
      
      function renderContentInIframe(content, destination_element) {
        var iframe = document.createElement('iframe');
        iframe.setAttribute("style", "width: 100%; height: 60%;");
        destination_element.appendChild(iframe);
        var doc = iframe.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();
      }

    function showTestResults() {
        if (test_results==null) {
            return;
            //not set yet
        }
        logging(test_results);
        try {
            test_results.forEach((element)=> {
            
            try {
                document.getElementById(element[3]).innerHTML=element[2];
            }
            catch (exception_var) {
                logging('An orphan test with the name '+element[3]+' gave a result of: ' +element[2]);
            } }) 
        }
        catch (exception_var) {
            logging(exception_var);
        }
    };

    function getTestResult(container) {
        //this is for complex tests only
        test_results.forEach((element)=> {
            try {
                if (element[3] == container) {
                    document.getElementById[container].innerHTML=element[2];
                }
            }
            catch (exception_var) {
                console.error(exception_var);
            }
        })
        return container;
    }
    
    function makeTable(containerdata) {
        const headerData = ["Disk Data I/0", "CPU%", "ContainerID (click for container-logs)", "Image", "Mem%", "Mem Used / Mem Max", "Container Name", "Network I/O", "Ports", "Running for / Exited since", "Size", "Status", "Reboot", "Is alive test", "Last tests results"];
        //const rowData = containerdata.split('\n');
        //rowData.pop();
        /*
        {
    "Command":"\"bash -c \\'waitress-s…\"",
    "CreatedAt":"2023-10-30 17:08:24 +0100 CET",
    "Image":"fabriziomereu/snap4city_installation_generator:dev.1.3.2",
    "Labels":"desktop.docker.io/binds/0/Source=C:\\Users\\fabri\\Desktop\\tesi\\Mysql\\latest.sql,desktop.docker.io/binds/0/Target=/data/mysql/a.sql,com.docker.compose.depends_on=db:service_started:true,com.docker.compose.project.working_dir=C:\\Users\\fabri\\Desktop\\tesi,com.docker.compose.project.config_files=C:\\Users\\fabri\\Desktop\\tesi\\docker-compose.yml,com.docker.compose.image=sha256:20c7adabdd2daaa4e33c5c06dff7f79c9d179ba11ddc32dfcddb3ef33add782a,com.docker.compose.oneoff=False,com.docker.compose.version=2.22.0,desktop.docker.io/binds/0/SourceKind=hostFile,com.docker.compose.project=tesi,com.docker.compose.replace=c4f06aeebfcdaff8ce3a1155399f4d53dd5bb2bf732d8a9c613f6e32fa33761f,com.docker.compose.service=app,com.docker.compose.config-hash=c566ba9d96f83cd6c34d41a4e24419891686d2de2a9f781999e95f0119de7b7f,com.docker.compose.container-number=1",
    "LocalVolumes":"0",
    "Mounts":"/run/desktop/m…",
    "Networks":"tesi_default",
    "Ports":"0.0.0.0:80->80/tcp",
    "RunningFor":"2 days ago",
    "Size":"0B",
    "State":"exited",
    "Status":"Exited (255) 2 days ago",
    "BlockIO":"0B / 0B",
    "CPUPerc":"0.00%",
    "Container":"9b13642d3479",
    "MemPerc":"0.00%",
    "MemUsage":"0B / 0B",
    "Name":"app",
    "NetIO":"0B / 0B",
    "PIDs":"0"
    }*/

    function createTable(headerData, rowData, name_of_table_value) {
        const table = document.createElement("table");
        table.setAttribute("class", "table  table-striped table-bordered")
        const thead = document.createElement("thead");
        thead.setAttribute("class", "thead-dark");
        const tbody = document.createElement("tbody");

        const headerRow = document.createElement("tr");
        headerData.forEach(headerText => {
            const th = document.createElement("th");
            th.setAttribute("class", "column");
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        rowData.forEach(rowValues => {
            const row = document.createElement("tr");
            var elements = Object.values(rowValues);
            var index_of_below_array = 0;
            elements.forEach(cellData => {
                const td = document.createElement("td");
                if (index_of_below_array === 3) {
                    var content_of_id_cell = '<a target="_blank" href="/container/'+cellData+'">'+cellData+'</a>';
                    td.innerHTML = content_of_id_cell;
                }
                else if (index_of_below_array === 20) {
                    var content_of_id_cell;
                    if (cellData === "running" != (elements[6] === "certbot/certbot"))
                        content_of_id_cell = cellData + '<span style="color: green;font-size: x-large;">●</span>';
                        else content_of_id_cell = cellData + '<span style="color: red;font-size: x-large;">●</span>';
                    td.innerHTML = content_of_id_cell;
                }
                else {
                    td.textContent = cellData;
                }
                row.appendChild(td);
                index_of_below_array = index_of_below_array + 1;
            });
            
            row.removeChild(row.childNodes[21]);
            row.removeChild(row.childNodes[16]);
            row.removeChild(row.childNodes[15]);
            row.removeChild(row.childNodes[13]);
            row.removeChild(row.childNodes[11]);
            row.removeChild(row.childNodes[8]);
            row.removeChild(row.childNodes[7]);
            row.removeChild(row.childNodes[5]);
            row.removeChild(row.childNodes[4]);
            row.removeChild(row.childNodes[2]);
            
            
            var rebootbutton = document.createElement("td");
            rebootbutton.innerHTML=`<input type="button" name="`+elements[12]+`" value="Reboot" class="btn btn-primary" onclick="rebootContainer('`+elements[3]+`')"/>`;
            row.appendChild(rebootbutton);
            var testsbutton = document.createElement("td");
            testsbutton.innerHTML=`<input type="button" name="`+elements[12]+`" value="Ping the port..." class="btn btn-info" onclick="runTests('`+elements[3]+`')"/>`;
            row.appendChild(testsbutton);
            tbody.appendChild(row);
            var testresults = document.createElement("td");
            testresults.setAttribute('id',row.childNodes[6].innerHTML);
            row.appendChild(testresults);

            tbody.appendChild(row);
            testresults.innerHTML=test_results_divs[row.childNodes[6].innerHTML];
            if (testresults.innerHTML == "undefined") {
                testresults.innerHTML = "No tests found";
            }
            
        });

        table.appendChild(thead);
        table.appendChild(tbody);
        const box = document.createElement("div");
        box.setAttribute("class", "p-5 text-center");
        box.setAttribute("style", "border-radius: 5rem; background-color: "+cg.next().value)
        const name_of_table = document.createElement("h1");
        name_of_table.setAttribute("class", "text-body-emphasis");
        name_of_table.innerHTML = name_of_table_value;
        box.appendChild(name_of_table);
        box.appendChild(table);
        return table;
    }

    
    const tableContainer = document.getElementById("table-container");
    tableContainer.innerText="";
    containerdata.sort((a, b) => {
        const nameA = a.Name.toUpperCase();
        const nameB = b.Name.toUpperCase();
    
        if (nameA < nameB) {
            return -1;
        }
        if (nameA > nameB) {
            return 1;
        }
        return 0;
    });
    
    

    //const table = createTable(headerData, containerdata);


    const categorizedData = {};

    containerdata.forEach(item => {
        const name = item.Name;
        let category = 'Unknown';
        for (const key in lookupTable) {
            if (name.startsWith(key.replace('*', ''))) {
            category = lookupTable[key];
            break;
            }
        }
        if (!categorizedData[category]) {
            categorizedData[category] = [];
        }
        categorizedData[category].push(item);
    });

    //console.log(categorizedData);
    
    const cg = colorGenerator();
    jQuery.each(categorizedData, function (i, val) {
        if (i != "Unknown") {
            const box = document.createElement("div");
            box.setAttribute("class", "p-5 text-center");
            box.setAttribute("style", "border-radius: 5rem; background-color: "+cg.next().value)
            const name_of_table = document.createElement("h1");
            name_of_table.setAttribute("class", "text-body-emphasis");
            name_of_table.innerHTML = i;
            box.appendChild(name_of_table);
            box.appendChild(createTable(headerData, val, i));
            const parser = new DOMParser();
            extra_data_locations.filter(innerArray => innerArray[0] === i).forEach(innerArray => {
                getExtraData(innerArray[1], box);
            });
            if (add_complex_test_table_depending_on_category(i)) {
                box.appendChild(parser.parseFromString(add_complex_test_table_depending_on_category(i), 'text/html').firstChild);
            }
            tableContainer.appendChild(box);
            }
            else console.log("Skipped unmanaged containers");
            
    });
    //tableContainer.appendChild(table);
}

function add_complex_test_table_depending_on_category(category) {
    var final_str = "";
    button_data.forEach((element) => {
        if (element["type"] === category) {final_str += element["data"]};
    });
    return final_str;
}

function* colorGenerator() {
    const colors = ['#00abff', '#cf71ff', '#fff466', '#3cb032', '#ff8a38'];
    let index = 0;
  
    while (true) {
      yield colors[index % colors.length];
      index++;
    }
  }
</script>
<label for="freezecontainers">Stop containers refresh</label>
<input type="checkbox" id="freezecontainers">
<form action="generate_pdf" method="POST">
    <input type="submit" class="btn btn-info" value="Generate pdf with all container logs (might take several seconds)" />
</form>
<div id="output" class="main">
    
    <br>
    
     
    
    <div id="table-container">

    </div>
    <div id="draggable" class="ui-widget-content">
        <p>Console Log (draggable)</p>
        <p class="ui-widget-header" id="see_logs"></p>
      </div>
</div>
<style>
    table th, table td {
      max-width: 200px;
      overflow: auto;
    }
    .main {
        position:relative;
    }
    .ui-widget-header {
        background-color: white;
        border-width: unset;
        border-color: black;
        border-style: solid;
        overflow: scroll;
        max-height: 240px;
    }
  #draggable { max-width: 700px; max-height: 300px; padding: 0.5em; float: left; margin: 0 10px 10px 0; border-style: solid; border-color: blue; background: white;}
  #draggable p { cursor: move; }
</style>
{% endblock %}
