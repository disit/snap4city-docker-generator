{% extends "main.html" %}
{% block title %}Updating from a past version{% endblock %}
{% block head %}
{{ super() }}
{% endblock %}
{% block content %}
<div class="container">
<br>
<p class="h1">Updating your system</p>
Here you will learn on how to update your Snap4City distribution from one version to another one. Note that you may only update a MicroX generated with this tool; we cannot guarantee for any other scenario.
<br>

<p class="h3">Step 1 - Download the tools</p>
Click <a href="get_updating_tools" target="_blank">here</a> to download the scripts which will aid you in updating your distribution.
<br>
<p class="h3">Step 2 - Backup everything</p>
It never hurts to do so, use the <i>backing-up-volumes/backup.sh</i> script to backup your docker volumes. You might want to make a separate dump of the database.
<br>
<p class="h3">Step 3 - Use your token to regenerate your distribution</p>
You will still need to provide values for variables which didn't exist at the time you first generated your distribution, be sure to check the values which have default values.
<br>
<p class="h3">Step 4 - Unzip the updated new configuration on the host</p>
Be sure that the directory which contains the configuration files shares the name with the old one; this should be true by default.
<br>
<p class="h3">Step 5 - Stop the execution of the containers</p>
Use <i>docker-compose down</i> to drop the containers; run this command in the old drectory. You might alternatively, if you have access to the docker GUI, stop them from the mentioned GUI.
<br>
<p class="h3">Step 6 - Run the script which imports the old data from local volumes</p>
Nifi, IoTapps and OpenSearch require data from your current installation; running <i>fix-files/adjust_for_updates.sh</i> will import said data. Before running the script, you must edit the paths (source and destination).
<br>
<p class="h3">Step 7 - Copy paste the old folder into the new one, without pasting files which already exist</p>
This will fix the rest of the configuration files.
<br>
<p class="h3">Step 8 - Start the old database container</p>
We need some of the old data.
<br>
<p class="h3">Step 9 - Update the database schema</p>
The script <i>updating/update_db.py</i> detects the current version of the db and trasforms its schema in order to be up to date in regard to the S4C version to which you are updating. You'll need to open the script and set your database credentials.
<br>
<p class="h3">Step 10 - Dump the tables which need to be preserved</p>
The script <i>updating/dump_db.py</i> does this automatically. You'll need to open the script and set your database credentials.
<br>
<p class="h3">Step 11 - Stop the old database container, delete its volume, then run the new database container</p>
Do not skip the second operation, or else the new container will try to use the old volume. Due to step 2, you will be able to restore your data if the need arises.
<br>
<p class="h3">Step 12 - Import the dump from step 10</p>
Either use the script <i>updating/load_db.py</i> or use tools like MySQL Workbench. You'll need to open the script and set your database credentials.
<br>
<p class="h3">Step 13 - Start the containers with docker-compose up -d</p>
The database is already running and requires no further operations.
<br>
<p class="h3">Step 14 - Run the post-setup.sh script in the new distribution</p>
This will fix some details in the kb.
<br>
<p class="h3">Step 15 - Log in all of your IoT-Apps</p>
This is required to regenerate the refresh token for authentication purposes 
<br>
<hr>
<p class="h1">Restoring volumes in case of downgrade to the original version</p>
If you want to return to the original version, you should try the following the instructions which explain different scenarios. Note that multiple might apply, depending on your situation.
<br>
<p class="h3">Case 1 - No volume was lost or edited, no files were deleted</p>
This happens if you proceeded to the upgrade without following the steps 9-12 from above. You don't need to do anything as all the data is where you left it.
<br>
<p class="h3">Case 2 - No volume except for the database was lost or edited, no configuration files were deleted</p>
All you need to do is to drop the volume of the database then restore the dump taken during step 2. Should you not have said dump but have the volume saved to a file from step 2, refer to <a rel="noopener" target="_blank" href="#restore_volume">Restore a volume</a>.
<br>
<p class="h3">Case 3 - Any number of volumes were lost, but said volumes saved to files are avaiable</p>
Refer to <a rel="noopener" target="_blank" href="#restore_volume">Restore a volume</a> to restore a container. You might need to iterate the process for multiple containers.
<br>
<p class="h3">Case 4 - Some files were lost, volumes backup are not available</p>
Some of the files might need simply regenerated by using your token to regenerate a configuration. Files which are generated during setup will need to be regenerated if missing, resulting possibly in inconsistencies due to keys generation; you might need to call for specific support. Files which are generated locally on your host cannot be restored short of restoring a periodic backup or restoring a deleted file. The latter is a process which can lead to an irrecuperable losses.
<br>
<hr>
<p class="h1"><a id="restore_volume">Restore a volume</a></p>
<p class="h3">Restore a volume from a file</p>
If you have a volume saved to a file genereated from step 2, you will need to run <i>backing-up-volumes/restore.sh</i> to recreate it (All volumes in the path where the script is executed are restored). The volume will have the name of the file. Be sure not to restore a volume on a preexisting volume to avoid inconsinstencies (but you can run the same script multiple times if nothing else edits the volumes).
<br>
<p class="h3">Use an existing volume in a container which didn't generate it</p>
If you need to use an existing volume in a container, for example because it is already populated by data (assuming there are no issues reading such a volume), you will need to edit the docker-compose.yaml file.
<ol>
    <li>Go at the bottom of the file, on the section </u>volumes</u></li>
    <li>For each volume which you need to have already existing, add a value <u>external</u> set to <u>true</u></li>
    <li>On the same level and volume, add a value <u>name</u> set to <u>the name of your container</u></li>
  </ol>
Here is an example:

<pre style="
    background-color: lightgrey;
    border-radius: 5px;
    max-width: 20%;
"><code>volumes:
  dashboarddb:
#####
volumes:
  dashboarddb:
    external: true
    name: some_name
</code></pre>
Note that telling docker that the container is external will skip the creation of the volume, meaning that a container won't start unless the volume already exists.
<br>
</div>
{% endblock %}
